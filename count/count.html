<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    
</head>
<body>
    <label for="days-since-last-incident">Ilość dni bez awarii:</label>
    <input type="number" id="days-since-last-incident" name="days-since-last-incident" readonly>
    
    <label for="record-days-without-incident">Rekord dni bez awarii:</label>
    <input type="number" id="record-days-without-incident" name="record-days-without-incident" readonly>
    
    <label for="accidents-in-year">Ilość awarii w roku:</label>
    <input type="number" id="accidents-in-year" name="accidents-in-year" readonly>
    
    <button id="incident-button">Czy awaria?</button>

    <script>
        const incidentButton = document.getElementById("incident-button");
        const daysSinceLastIncidentField = document.getElementById("days-since-last-incident");
        const recordDaysWithoutIncidentField = document.getElementById("record-days-without-incident");
        const accidentsInYearField = document.getElementById("accidents-in-year");

        const getData = () => fetch("data.json").then(response => response.json());

        const updateData = data => fetch("data.json", { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) });

        const updateFields = ({ daysSinceLastIncident, recordDaysWithoutIncident, accidentsInYear }) => {
            daysSinceLastIncidentField.value = daysSinceLastIncident || 0;
            recordDaysWithoutIncidentField.value = recordDaysWithoutIncident || 0;
            accidentsInYearField.value = accidentsInYear || 0;
        };

        incidentButton.addEventListener("click", async () => {
            const currentDate = new Date();
            const data = await getData();

            const lastIncidentDate = new Date(data.lastIncidentDate || currentDate.toJSON());
            const daysSinceLastIncident = Math.floor((currentDate - lastIncidentDate) / (1000 * 60 * 60 * 24));

            if (isNaN(daysSinceLastIncident) || daysSinceLastIncident < 0) return;

            const newDaysSinceLastIncident = data.daysSinceLastIncident + daysSinceLastIncident;
            const newRecordDaysWithoutIncident = Math.max(data.recordDaysWithoutIncident, newDaysSinceLastIncident);
            const newAccidentsInYear = data.accidentsInYear + 1;

            await updateData({ lastIncidentDate: currentDate.toJSON(), daysSinceLastIncident: newDaysSinceLastIncident, recordDaysWithoutIncident: newRecordDaysWithoutIncident, accidentsInYear: newAccidentsInYear });

            updateFields({ daysSinceLastIncident: newDaysSinceLastIncident, recordDaysWithoutIncident: newRecordDaysWithoutIncident, accidentsInYear: newAccidentsInYear });
        });

        getData().then(updateFields);
    </script>
</body>
</html>
